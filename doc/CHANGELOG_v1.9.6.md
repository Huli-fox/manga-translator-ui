# v1.9.6 更新日志

发布日期：2025-12-19

## ✨ 新功能

### 超分模型
- **新增 MangaJaNai 超分模型**：支持 x2、x4、DAT2 x4 三种模式，共 17 个模型
- **模型自动选择**：根据图片分辨率自动选择最佳模型（1200p-2048p）
- **切割逻辑统一**：与 RealCUGAN 保持一致（overlap=16, tile_size=400）

### 文本过滤
- **新增文本过滤列表功能**：支持自定义过滤不需要翻译的文本
- **过滤开关**：可在配置中启用或禁用文本过滤功能

## ⚡ 优化

### 翻译器
- **JSON 格式请求**：翻译器发送的请求改为 JSON 格式，提高解析准确性
- **JSON 响应解析**：支持解析 JSON 数组格式的翻译结果，兼容纯文本格式
- **调试日志优化**：翻译器原始响应日志改为 debug 级别

### 配置文件
- **配置读取鲁棒性增强**：改进配置文件读取逻辑，提高容错能力
- **upscale_ratio 字段扩展**：支持字符串类型（如 "x2", "x4", "DAT2 x4"）

## 🐛 修复

### 模型下载
- **下载验证增强**：添加 SHA256 哈希验证，检测下载失败的文件（< 1KB）
- **模型迁移**：自动迁移旧目录的模型文件到新目录

### Inpainting 修复
- **ONNX Runtime 内存优化**：移除可能导致内存碎片化的配置，优化内存管理
- **内存释放优化**：ONNX 推理后及时释放临时变量并强制垃圾回收
- **新增"强制使用PyTorch"选项**：用户可在设置中启用，跳过 ONNX 直接使用 PyTorch，避免内存问题
- **改进错误提示**：启动时检查备用模型，ONNX 失败时给出清晰的降级提示
- **修复参数传递**：修复 `ModelWrapper.load` 方法的参数传递问题

## 📦 依赖

- 新增 `spandrel==0.4.1` 依赖，用于加载 DAT2 模型
